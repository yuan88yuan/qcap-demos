# `test-avcap.cpp` 作用及執行流程

`test-avcap.cpp` 是一個使用 `qcap` 函式庫從特定硬體設備（一個 "SC0750 PCI" 卡，很可能是 Yuan 的 SDI 擷取卡）執行即時影音擷取的範例程式。

此程式展示了一個進階的、零拷貝（zero-copy）的擷取與處理管線。

## 執行流程

1.  **設備初始化**：程式初始化 "SC0750 PCI" 擷取卡，並將輸入設定為帶有嵌入式音訊的 SDI 訊號。

2.  **GPUDirect 緩衝區**：程式分配了特殊的 `GPUDirect` 緩衝區。這允許擷取卡將影像資料直接寫入 GPU 可存取的記憶體中，從而避免了通過系統 RAM 的額外記憶體複製，提高了效率。

3.  **訊號偵測**：程式等待一個有效的影像訊號。核心處理管線僅在透過 `OnFormatChanged` 回呼偵測到特定格式（3840x2160 @ 50fps）時才會啟動。

4.  **影像擷取回呼 (`OnVideoPreview`)**：當硬體擷取到一個影像影格時，它會將其放入一個 GPUDirect 緩衝區並觸發此回呼。然後，該回呼將緩衝區推送到一個佇列中以進行處理。

5.  **影像處理 (`OnVsrcQ`)**：一個獨立的執行緒從佇列中取出影格並執行以下操作：
    *   **去交錯**：透過分別處理頂部和底部欄位來處理交錯式影像。
    *   **CUDA 加速縮放**：呼叫一個自訂的 CUDA 核心 (`zppiHoriDownscale2X_Y210`) 來執行 2 倍水平縮小。
    *   **V4L2 輸出**：處理後的影像被送到一個 V4L2 迴環設備 (`/dev/video1`)。這使得處理後的串流可以像網路攝影機一樣被系統上的其他應用程式使用。

6.  **音訊擷取與輸出 (`OnAudioPreview`, `OnAsrcQ`)**：音訊被平行擷取。擷取到的音訊緩衝區未經修改地直接傳遞到第二個 V4L2 迴環設備 (`/dev/video2`)。

7.  **動態管線**：整個處理管線在偵測到有效訊號時動態建立，並在訊號遺失時銷毀，使應用程式能夠應對輸入訊號的變化。
