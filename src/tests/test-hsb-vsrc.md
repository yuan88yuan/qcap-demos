# `test-hsb-vsrc.cpp` 作用及執行流程

`test-hsb-vsrc.cpp` 是一個針對 `qcap` 中特定影像來源 "HSB" 後端的測試程式。此後端設計用於透過 RDMA (遠端直接記憶體存取) 和 InfiniBand 介面接收高速網路影像串流。

## 執行流程

1.  **HSB 來源設定**：程式建立一個 `qcap2_video_source` 物件，並將其設定為使用 `QCAP2_VIDEO_SOURCE_BACKEND_TYPE_HSB` 後端。

2.  **RDMA 設定**：程式會自動偵測系統上第一個 InfiniBand 設備（例如 Mellanox 卡），並設定來源以使用它進行通訊。同時，它也設定了遠端發送影像資料的 "Holo-link" 伺服器的 IP 位址。

3.  **啟動來源**：啟動影像來源，此動作會建立 RDMA 連線並準備接收傳入的影像影格。影格預期會被直接傳輸到 GPU 記憶體中，繞過 CPU 和系統 RAM，以達到最高效能。

4.  **影格接收 (`OnVsrc`)**：每當有新影格到達時，一個回呼函式會被執行。此函式從影像來源 `pop` 出新影格。接收到的緩衝區是 GPU 記憶體區域的一個控制代碼 (handle)。

5.  **快照功能**：程式在一個迴圈中運行，持續接收影格。如果使用者按下 `s` 鍵：
    *   程式會對當前的 GPU 影格進行快照。
    *   此操作涉及一個 `cudaMemcpy2D` 動作，將影格資料從 GPU 設備記憶體複製到預先分配的主機 (CPU) 記憶體緩衝區。
    *   接著，這個位於主機端的緩衝區被儲存到一個名為 `snapshot` 的檔案中。

此測試展示了一個高效能的影像擷取情境，其中遠端來源將影像直接串流到本機 GPU 的記憶體中進行處理，並提供了一個簡單的機制，可以透過儲存快照來驗證接收到的資料。
